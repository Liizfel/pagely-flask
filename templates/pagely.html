<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagely - Minha Estante Cottage</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ‚≠êÔ∏è CONFIGURA√á√ÉO DE CORES E FONTES COTTAGE ‚≠êÔ∏è -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cottage-text': '#4A4A4A',
                        'cottage-detail': '#A08C7A',
                        'cottage-card': '#F7F4EB',
                        'cottage-accent': '#A3B18A',
                        'cottage-primary': '#B8860B',
                        'cottage-bg': '#F5F5DC',
                    },
                    fontFamily: {
                        'pagely-script': ['Dancing Script', 'cursive'],
                        'pagely-title': ['Playfair Display', 'serif'],
                        'pagely-body': ['Lora', 'serif'],
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Lora:ital,wght@0,400..700;1,400..700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilo de Fundo Quadriculado */
        .ruled-background {
            background-color: #F5F5DC; /* cottage-bg */
            background-image:
                linear-gradient(to bottom, rgba(160, 140, 122, 0.05) 1px, transparent 1px),
                linear-gradient(to right, rgba(160, 140, 122, 0.03) 1px, transparent 1px);
            background-size: 25px 25px;
            font-family: 'Lora', sans-serif;
            color: theme('colors.cottage-text');
            min-height: 100vh;
        }

        .floating-header {
            background-color: rgba(247, 244, 235, 0.9);
            backdrop-filter: blur(2px);
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.1), 0 1px 3px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .granulated-texture::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 5px 5px;
            opacity: 0.5;
            z-index: 1;
            border-radius: 0.75rem;
        }

        .book-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.1), 0 1px 3px -1px rgba(0, 0, 0, 0.03);
            border-left: 4px solid theme('colors.cottage-detail');
        }
        .book-card:hover {
            transform: translateY(-3px) rotateZ(0.5deg);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .vintage-button {
            background-color: theme('colors.cottage-primary');
            color: theme('colors.cottage-card');
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.1s;
        }
        .vintage-button:hover {
            filter: brightness(0.9);
        }
        .vintage-button:active {
            transform: scale(0.99);
        }
        .star { color: #FFD700; /* Gold */ }
        .important { color: #FF4500; /* Red-Orange */ }
        .schedule-item-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .schedule-item:hover .schedule-item-actions {
            opacity: 1;
        }
        /* Estilo para o √≠cone de capa (para garantir o tamanho do emoji/letra) */
        .cover-icon {
            font-size: 3rem; 
        }

        /* ‚≠ê Estilo para o Cronograma (Caderno Pautado) ‚≠ê */
        .ruled-schedule {
            background-color: theme('colors.cottage-card');
            /* Linhas horizontais sutis */
            background-image: linear-gradient(to bottom, theme('colors.cottage-detail') 1px, transparent 1px);
            background-size: 100% 1.5rem; /* Altura da linha de 1.5rem (24px) */
            line-height: 1.5rem; /* Garante que o texto se alinhe com as linhas */
            padding: 0.5rem 0.75rem;
            position: relative;
            z-index: 2;
        }
        .ruled-schedule .schedule-item {
            padding: 0 0;
            margin: 0;
            transition: background-color 0.2s;
        }
        /* ‚≠ê Estilo para o badge de Status ‚≠ê */
        .status-badge {
            position: absolute;
            top: 0;
            left: 0;
            padding: 0.25rem 0.75rem;
            border-bottom-right-radius: 0.5rem;
            font-weight: bold;
            font-size: 0.75rem;
            line-height: 1;
            z-index: 10;
        }
    </style>
    
</head>
<body class="ruled-background p-4 sm:p-8">

    <header class="floating-header granulated-texture p-4 rounded-xl sticky top-4 z-10 mx-auto max-w-7xl border border-cottage-detail/30 relative">
        <div class="flex flex-wrap justify-between items-center z-20 relative">
            <div class="flex items-center space-x-2">
                   <img src="{{ url_for('static', filename='logo.webp') }}"
                    alt="Logo Pagely"
                    class="w-16 h-16 text-cottage-primary object-contain">
                
                <div>
                    <h1 class="text-4xl font-pagely-script tracking-wider text-cottage-primary font-bold leading-none" style="font-size: 2.8rem;">
                        Pagely
                    </h1>
                    <p class="text-sm italic text-cottage-detail mt-1 font-pagely-body">
                        feito para quem vive entre p√°ginas.
                    </p>
                </div>
            </div>
            
            <!-- ELEMENTOS DE USU√ÅRIO E LOGOUT -->
            <div class="text-sm font-pagely-body flex items-center space-x-4">
                <!-- ‚≠êÔ∏è NOME DO USU√ÅRIO INJETADO PELO FLASK ‚≠êÔ∏è -->
                <span id="user-info" class="text-xs sm:text-sm text-cottage-detail/80">
                    Usu√°rio: {{ user_name }}
                </span>
                
                <!-- Bot√£o de Logout -->
                <button id="logout-btn" class="px-4 py-2 rounded-full text-base uppercase shadow-sm flex items-center space-x-1 bg-cottage-detail text-cottage-card hover:bg-cottage-detail/80 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span>Sair</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MENSAGENS GLOBAIS -->
    <div id="message-box" class="mt-8 mx-auto max-w-7xl"></div>
    
    <!-- CONTE√öDO PRINCIPAL: DUAS COLUNAS COMPACTAS -->
    <main class="container mx-auto mt-8 px-4 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-8">
            
            <!-- COLUNA ESQUERDA: WIDGETS EMPILHADOS (Seu Canto de Leitura) -->
            <section id="widgets-dashboard" class="space-y-6">
                <h2 class="text-2xl font-pagely-title text-cottage-detail mb-2 font-bold">Seu Canto de Leitura</h2>
                
                <!-- ‚≠êÔ∏è CRONOGRAMA DIN√ÇMICO ‚≠êÔ∏è -->
                <div class="bg-cottage-card p-5 rounded-xl shadow-md border border-cottage-accent/30">
                    <div class="flex justify-between items-center mb-3 border-b pb-1 border-cottage-accent/30">
                        <h3 class="text-xl font-pagely-title text-cottage-text font-bold">Cronograma</h3>
                        <button id="add-schedule-btn" class="text-cottage-primary hover:text-cottage-accent transition duration-200" title="Adicionar Atividade">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        </button>
                    </div>
                    <!-- ‚≠ê NOVO ESTILO: Caderno Pautado ‚≠ê -->
                    <ul id="schedule-list" class="ruled-schedule text-sm space-y-0 text-cottage-text font-pagely-body rounded-md">
                        <!-- Itens do cronograma ser√£o injetados aqui -->
                        <div id="schedule-loading" class="text-center text-cottage-detail">Carregando cronograma...</div>
                    </ul>
                </div>

                <!-- ‚≠êÔ∏è PROGRESSO MENSAL DIN√ÇMICO ‚≠êÔ∏è -->
                <div class="bg-cottage-card p-5 rounded-xl shadow-md border border-cottage-accent/30">
                    <h3 class="text-xl font-pagely-title text-cottage-text mb-3 border-b pb-1 border-cottage-accent/30 font-bold">Progresso Mensal</h3>
                    <div id="progress-indicator" class="text-6xl font-pagely-title text-center text-cottage-primary font-bold">
                        0
                    </div>
                    <p class="text-xs text-center text-cottage-accent mt-4">Livros finalizados este m√™s.</p>
                </div>

                <!-- ‚≠êÔ∏è PERFORMANCE ANUAL DIN√ÇMICA (GR√ÅFICO DE ESTRELAS) ‚≠êÔ∏è -->
                <div class="bg-cottage-card p-5 rounded-xl shadow-md border border-cottage-accent/30">
                    <h3 class="text-xl font-pagely-title text-cottage-text mb-3 border-b pb-1 border-cottage-accent/30 font-bold">Performance Anual</h3>
                    <div id="performance-indicator" class="text-4xl font-pagely-title text-center text-cottage-primary font-bold">
                        <!-- Conte√∫do injetado por JS -->
                        0.0
                    </div>
                    <p class="text-xs text-center text-cottage-text mt-2">M√©dia de Avalia√ß√£o ({{ user_name }})</p>
                </div>
                
            </section>
            
            <!-- COLUNA DIREITA: CAT√ÅLOGO COMPACTO (Minha Estante Vintage) -->
            <section id="catalog-compact-view" class="bg-cottage-card p-6 rounded-xl shadow-xl border-4 border-cottage-accent/50 h-fit">
                
                <div class="flex flex-wrap justify-between items-center mb-6 border-b pb-3 border-cottage-accent/50">
                    <h2 class="text-3xl font-pagely-title text-cottage-text font-bold">
                        Minha Estante Vintage
                    </h2>
                    <!-- Bot√£o Adicionar Livro (Movido para dentro da Estante) -->
                    <button id="add-book-btn" class="vintage-button px-4 py-2 rounded-full text-base uppercase shadow-sm flex items-center space-x-1 bg-cottage-primary text-cottage-card">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-plus"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M9 10h6"/><path d="M12 7v6"/></svg>
                        <span>Adicionar Livro</span>
                    </button>
                </div>

                <!-- Indicadores de status do Cat√°logo -->
                <div id="loading-indicator" class="text-center mt-8 text-cottage-detail font-pagely-title text-2xl">
                    <p>Carregando Cat√°logo...</p>
                </div>
                <!-- MENSAGEM DE P√ÅGINA VAZIA (Com nome do usu√°rio) -->
                <p id="no-books-message" class="text-center text-xl mt-8 text-cottage-accent hidden">
                    Seja bem-vindo, **{{ user_name }}**! Sua estante est√° vazia. Adicione o primeiro livro!
                </p>
                
                <!-- Grid de Livros (Adaptado para caber na coluna) -->
                <div id="books-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-4 mt-6">
                    <!-- Livros ser√£o adicionados aqui via JavaScript/API -->
                </div>

            </section>
            
        </div>
    </main>

    <!-- ‚≠êÔ∏è MODAL DE ADI√á√ÉO/EDI√á√ÉO DE LIVRO ‚≠êÔ∏è -->
    <div id="book-modal" class="fixed inset-0 bg-cottage-text/70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-cottage-card p-8 rounded-xl max-w-lg w-full shadow-2xl border-4 border-cottage-accent/50">
            <h3 id="modal-title" class="text-3xl font-pagely-title text-cottage-text mb-6 font-bold">Adicionar Novo Livro</h3>
            <form id="book-form">
                <input type="hidden" id="book-id">
                
                <div class="mb-4">
                    <label for="title" class="block font-bold mb-1 text-cottage-detail">T√≠tulo:</label>
                    <input type="text" id="title" required class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text">
                </div>
                
                <div class="mb-4">
                    <label for="author" class="block font-bold mb-1 text-cottage-detail">Autor:</label>
                    <input type="text" id="author" required class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text">
                </div>
                
                <!-- ‚≠ê NOVO CAMPO: STATUS DE LEITURA ‚≠ê -->
                <div class="mb-4">
                    <label for="status" class="block font-bold mb-1 text-cottage-detail">Status:</label>
                    <select id="status" class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text">
                        <!-- Op√ß√µes preenchidas via JS -->
                    </select>
                </div>

                <!-- ‚≠ê Sele√ß√£o de Capa/√çcone ‚≠ê -->
                <div class="mb-4">
                    <label for="cover-icon" class="block font-bold mb-1 text-cottage-detail">Capa/√çcone Sugerido:</label>
                    <select id="cover-icon" class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text">
                        <!-- Op√ß√µes ser√£o preenchidas via JS para incluir emojis -->
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="year" class="block font-bold mb-1 text-cottage-detail">Ano de Publica√ß√£o:</label>
                    <input type="number" id="year" class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text" placeholder="Opcional">
                </div>

                <!-- Campo de Nota/Estrelas -->
                <div class="mb-4">
                    <label for="rating" class="block font-bold mb-1 text-cottage-detail">Nota (Estrelas):</label>
                    <input type="number" id="rating" min="0" max="5" step="0.5" class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text" placeholder="0.0 a 5.0">
                </div>
                
                <!-- Campo de Resenha -->
                <div class="mb-4">
                    <label for="review" class="block font-bold mb-1 text-cottage-detail">Resenha:</label>
                    <textarea id="review" rows="4" class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text" placeholder="Escreva sua opini√£o sobre o livro..."></textarea>
                </div>


                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="close-book-modal-btn" class="px-6 py-3 bg-cottage-detail text-cottage-card rounded-full shadow hover:bg-cottage-detail/80 transition duration-200 text-sm font-pagely-title font-bold">
                        Cancelar
                    </button>
                    <button type="submit" id="submit-button" class="vintage-button px-6 py-3 rounded-full shadow-lg text-sm">
                        Salvar Livro
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ‚≠êÔ∏è MODAL DE DETALHES DO LIVRO (Visualiza√ß√£o e Edi√ß√£o de Data Finalizada) ‚≠êÔ∏è -->
    <div id="detail-modal" class="fixed inset-0 bg-cottage-text/70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-cottage-card p-8 rounded-xl max-w-xl w-full shadow-2xl border-4 border-cottage-primary/50">
            
            <div class="flex justify-between items-start mb-6 border-b pb-3 border-cottage-detail/50">
                <h3 id="detail-title" class="text-3xl font-pagely-title text-cottage-primary font-bold">Detalhes do Livro</h3>
                <button id="close-detail-modal-btn" class="text-cottage-detail hover:text-cottage-text transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>

            <div class="space-y-4 text-cottage-text">
                <!-- Status ser√° exibido aqui, na div de status -->
                <p><strong>Status Atual:</strong> <span id="detail-status" class="font-bold"></span></p>
                <p><strong>Escritor:</strong> <span id="detail-author"></span></p>
                <p><strong>Ano de Lan√ßamento:</strong> <span id="detail-year"></span></p>
                <p><strong>Nota:</strong> <span id="detail-rating"></span></p>
                <p><strong>Data de Cadastro:</strong> <span id="detail-date-added"></span></p>
                
                <div class="border-t border-cottage-accent/50 pt-4">
                    <h4 class="text-xl font-pagely-title mb-2 font-bold text-cottage-detail">Resenha</h4>
                    <p id="detail-review" class="italic text-sm bg-cottage-bg p-3 rounded-md"></p>
                </div>

                <!-- Campo de Edi√ß√£o de Data Finalizada (Para alimentar o Progresso Mensal) -->
                <div class="border-t border-cottage-accent/50 pt-4">
                    <h4 class="text-xl font-pagely-title mb-2 font-bold text-cottage-detail">Finaliza√ß√£o de Leitura</h4>
                    <label for="detail-date-finished" class="block font-bold mb-1 text-cottage-detail">Data que finalizou a leitura:</label>
                    <input type="date" id="detail-date-finished"
                            class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text">
                    <button id="save-date-btn" class="vintage-button mt-3 px-4 py-2 text-sm rounded-lg shadow-md">Salvar Data</button>
                    <p id="date-save-message" class="text-xs text-cottage-accent mt-2"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚≠êÔ∏è MODAL DE CRONOGRAMA ‚≠êÔ∏è -->
    <div id="schedule-modal" class="fixed inset-0 bg-cottage-text/70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-cottage-card p-8 rounded-xl max-w-md w-full shadow-2xl border-4 border-cottage-accent/50">
            <h3 id="schedule-modal-title" class="text-3xl font-pagely-title text-cottage-text mb-6 font-bold">Adicionar Atividade</h3>
            <form id="schedule-form">
                <input type="hidden" id="schedule-item-id">
                
                <div class="mb-4">
                    <label for="activity" class="block font-bold mb-1 text-cottage-detail">Atividade:</label>
                    <input type="text" id="activity" required class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text" placeholder="Ex: Reler cap√≠tulo 3">
                </div>
                
                <div class="mb-4">
                    <label for="period" class="block font-bold mb-1 text-cottage-detail">Per√≠odo:</label>
                    <select id="period" required class="w-full p-3 rounded-md border-2 border-cottage-accent bg-cottage-bg/80 focus:border-cottage-primary focus:ring-0 text-cottage-text">
                        <option value="Hoje">Hoje</option>
                        <option value="Amanh√£">Amanh√£</option>
                        <option value="Esta Semana">Esta Semana</option>
                        <option value="Pr√≥xima Semana">Pr√≥xima Semana</option>
                        <option value="Este M√™s">Este M√™s</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-6 mt-6">
                    <label class="flex items-center space-x-2 text-cottage-detail font-bold cursor-pointer">
                        <input type="checkbox" id="is_important" class="rounded border-cottage-accent text-cottage-primary shadow-sm focus:ring-0">
                        <span>Importante</span>
                        <span class="important ml-1">!</span>
                    </label>
                    <label class="flex items-center space-x-2 text-cottage-detail font-bold cursor-pointer">
                        <input type="checkbox" id="is_favorite_schedule" class="rounded border-cottage-accent text-cottage-primary shadow-sm focus:ring-0">
                        <span>Favorito</span>
                        <span class="star ml-1">‚òÖ</span>
                    </label>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="close-schedule-modal-btn" class="px-6 py-3 bg-cottage-detail text-cottage-card rounded-full shadow hover:bg-cottage-detail/80 transition duration-200 text-sm font-pagely-title font-bold">
                        Cancelar
                    </button>
                    <button type="submit" id="save-schedule-btn" class="cottage-button px-6 py-3 bg-cottage-accent text-cottage-text rounded-full shadow-lg text-sm">
                        Salvar Atividade
                    </button>
                </div>
                <button type="button" id="delete-schedule-btn" class="text-red-500 hover:text-red-700 mt-4 text-sm w-full">
                    Excluir Atividade
                </button>
            </form>
        </div>
    </div>


    <script>
        
        const booksGrid = document.getElementById('books-grid');
        const noBooksMessage = document.getElementById('no-books-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const addBookBtn = document.getElementById('add-book-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Modal Livro
        const bookModal = document.getElementById('book-modal');
        const bookForm = document.getElementById('book-form');
        const closeBookModalBtn = document.getElementById('close-book-modal-btn');
        
        // Modal Detalhe
        const detailModal = document.getElementById('detail-modal');
        const closeDetailModalBtn = document.getElementById('close-detail-modal-btn');
        const saveDateBtn = document.getElementById('save-date-btn');
        
        // Widget Cronograma
        const scheduleList = document.getElementById('schedule-list');
        const addScheduleBtn = document.getElementById('add-schedule-btn');
        const scheduleModal = document.getElementById('schedule-modal');
        const closeScheduleModalBtn = document.getElementById('close-schedule-modal-btn');
        const scheduleForm = document.getElementById('schedule-form');
        const deleteScheduleBtn = document.getElementById('delete-schedule-btn');
        
        // Widgets M√©tricas
        const progressIndicator = document.getElementById('progress-indicator');
        const performanceIndicator = document.getElementById('performance-indicator');

        // Vari√°vel global para armazenar os livros carregados (necess√°rio para o modal de detalhes)
        let loadedBooks = [];

        // ‚≠ê Mapeamento de √çcones/Capas
        const COVER_ICONS = [
            { value: 'initial', text: 'Letra Inicial do T√≠tulo' },
            { value: 'fantasy', text: 'üè∞ Fantasia' },
            { value: 'mystery', text: 'üîç Mist√©rio' },
            { value: 'science', text: 'üöÄ Fic√ß√£o Cient√≠fica' },
            { value: 'romance', text: '‚ù§Ô∏è Romance' },
            { value: 'history', text: 'üèõÔ∏è Hist√≥ria/Ensaio' },
            { value: 'nature', text: 'üå≥ Natureza/Aventura' },
            { value: 'poesia', text: 'üìù Poesia' },
        ];

        // ‚≠ê NOVO: Mapeamento de Status de Leitura
        const STATUS_MAP = {
            'Lendo': { text: 'LENDO', class: 'bg-yellow-400 text-yellow-900 border-yellow-600' },
            'Lido': { text: 'LIDO', class: 'bg-green-500 text-green-900 border-green-700' },
            'Abandonado': { text: 'ABANDONADO', class: 'bg-red-400 text-red-900 border-red-700' },
            'Desejo': { text: 'DESEJO', class: 'bg-cottage-accent text-cottage-card border-cottage-detail' },
        };
        
        /**
         * FUN√á√ïES GERAIS
         */
        function showMessage(text, type = 'success') {
            const colors = {
                success: 'bg-cottage-accent/20 border-cottage-accent text-cottage-text',
                error: 'bg-red-200 border-red-500 text-red-700',
            };
            
            const div = document.createElement('div');
            div.className = `p-3 mb-4 rounded-lg border ${colors[type]} transition-opacity duration-300 mx-auto max-w-7xl`;
            div.textContent = text;
            document.getElementById('message-box').appendChild(div);

            setTimeout(() => {
                div.classList.add('opacity-0');
                div.addEventListener('transitionend', () => div.remove());
            }, 3000);
        }

        async function handleLogout() {
            window.location.href = '{{ url_for("logout") }}';
        }

        // ‚≠ê Fun√ß√£o para obter o conte√∫do da capa (letra ou emoji)
        function getCoverContent(book) {
            const selectedIcon = COVER_ICONS.find(icon => icon.value === book.cover_icon);
            
            if (selectedIcon && selectedIcon.value !== 'initial') {
                // Retorna apenas o emoji (assumindo que o emoji √© o primeiro caractere da string 'text')
                return `<span class="cover-icon text-5xl">${selectedIcon.text.split(' ')[0]}</span>`;
            }
            
            // Padr√£o: Letra inicial (e usa classe de tamanho maior)
            const coverInitial = book.title ? book.title.charAt(0).toUpperCase() : '?';
            return `<span class="text-6xl font-pagely-title">${coverInitial}</span>`;
        }

        // ‚≠ê Preenche o seletor de √≠cones
        function populateCoverIconSelector(currentValue = 'initial') {
            const select = document.getElementById('cover-icon');
            select.innerHTML = '';

            COVER_ICONS.forEach(icon => {
                const option = document.createElement('option');
                option.value = icon.value;
                option.textContent = icon.text;
                if (icon.value === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        // ‚≠ê NOVO: Preenche o seletor de Status
        function populateStatusSelector(currentValue = 'Lendo') {
            const select = document.getElementById('status');
            select.innerHTML = '';

            Object.keys(STATUS_MAP).forEach(statusKey => {
                const option = document.createElement('option');
                option.value = statusKey;
                option.textContent = STATUS_MAP[statusKey].text;
                if (statusKey === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // ‚≠ê Fun√ß√£o para renderizar o gr√°fico de estrelas (para Performance Anual)
        function renderStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            let starsHtml = '';

            // Estrelas cheias
            for (let i = 0; i < fullStars; i++) {
                starsHtml += `<span class="star">‚òÖ</span>`;
            }

            // Meia estrela (usando SVG para melhor controle)
            if (hasHalfStar) {
                // SVG para meia estrela
                starsHtml += `
                    <svg class="star inline-block align-text-bottom" width="1em" height="1em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="0">
                        <defs><linearGradient id="half"><stop offset="50%" stop-color="#FFD700" /><stop offset="50%" stop-color="#D1D5DB" /></linearGradient></defs>
                        <path fill="url(#half)" d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    </svg>
                `;
            }

            // Estrelas vazias (para completar 5)
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += `<span class="text-gray-300">‚òÖ</span>`; // Cor mais clara para estrela vazia
            }

            return starsHtml;
        }


        /**
         * LIVROS (CARREGAMENTO, CRIA√á√ÉO, DETALHE)
         */
        async function loadBooks() {
            loadingIndicator.classList.remove('hidden');
            booksGrid.innerHTML = '';
            
            try {
                const response = await fetch('/api/books');
                
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Falha ao carregar livros: ' + response.statusText);
                }
                
                loadedBooks = await response.json();
                renderBooks(loadedBooks);
                loadMetrics(); // Carrega m√©tricas ap√≥s carregar livros
                
            } catch (error) {
                console.error("Erro ao buscar livros:", error);
                showMessage("Falha ao carregar o cat√°logo. Tente recarregar a p√°gina.", 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function renderBooks(books) {
            booksGrid.innerHTML = '';
            
            if (books.length === 0) {
                noBooksMessage.classList.remove('hidden');
                return;
            }

            noBooksMessage.classList.add('hidden');

            books.forEach(book => {
                const card = document.createElement('div');
                card.className = 'book-card bg-cottage-card p-4 rounded-xl flex flex-col justify-between cursor-pointer border-4 border-cottage-accent/10 relative';
                card.setAttribute('data-id', book.id);
                card.addEventListener('click', () => openBookDetailModal(book.id)); // Abre o modal de detalhes ao clicar

                const coverHTML = getCoverContent(book); // ‚≠ê Usa a nova fun√ß√£o
                const year = book.publication_year || 'N/A';
                const rating = book.rating ? book.rating.toFixed(1) : 'N/A';
                const isFavoriteIcon = book.is_favorite === 1 ? `<span class="star text-lg" title="Favorito">‚òÖ</span>` : '';
                
                // ‚≠ê NOVO: Badge de Status
                const statusInfo = STATUS_MAP[book.status] || STATUS_MAP['Lendo']; // Default para Lendo
                const statusBadge = `<div class="status-badge border border-b-2 border-r-2 ${statusInfo.class}">${statusInfo.text}</div>`;


                card.innerHTML = `
                    <div>
                        <div class="w-full h-40 sm:h-52 bg-cottage-detail mb-4 rounded-lg flex items-center justify-center border-4 border-cottage-primary/50 text-cottage-card shadow-inner relative">
                            ${statusBadge}
                            ${coverHTML}
                        </div>
                        <h4 class="text-xl font-pagely-title text-cottage-text truncate font-bold" title="${book.title}">${book.title}</h4>
                        <p class="text-sm italic text-cottage-accent mt-1">Por ${book.author}</p>
                        <p class="text-xs text-cottage-detail/80 mt-1">Publicado em ${year}</p>
                    </div>

                    <div class="mt-4 pt-3 border-t border-cottage-detail/30 flex justify-between items-center text-sm">
                        <div class="flex items-center space-x-2">
                            ${isFavoriteIcon}
                            <span class="text-cottage-primary flex items-center space-x-1">
                                <!-- Estrela simples para o card -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-cottage-primary"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                <span class="font-bold">${rating}</span>
                            </span>
                        </div>
                        
                        <!-- Bot√£o de Edi√ß√£o R√°pida (Mantido para ser re-usado no futuro se necess√°rio) -->
                        <button data-id="${book.id}" data-action="edit-form" class="text-cottage-accent hover:text-cottage-primary transition duration-200 p-1 hidden" title="Editar Formulario">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                        </button>
                    </div>
                `;

                booksGrid.appendChild(card);
            });
        }

        async function saveBook(e) {
            e.preventDefault();

            const title = document.getElementById('title').value.trim();
            const author = document.getElementById('author').value.trim();
            const yearInput = document.getElementById('year').value.trim();
            const ratingInput = document.getElementById('rating').value.trim();
            const reviewInput = document.getElementById('review').value.trim();
            const coverIcon = document.getElementById('cover-icon').value; 
            // ‚≠ê NOVO: Captura o status
            const status = document.getElementById('status').value;
            const bookId = document.getElementById('book-id').value;

            if (!title || !author) {
                showMessage("T√≠tulo e Autor s√£o obrigat√≥rios.", 'error');
                return;
            }
            
            // Simples valida√ß√£o de nota
            const rating = ratingInput ? parseFloat(ratingInput) : null;
            if (rating !== null && (rating < 0 || rating > 5)) {
                showMessage("A nota deve ser entre 0.0 e 5.0.", 'error');
                return;
            }

            const bookData = {
                title: title,
                author: author,
                year: yearInput,
                review: reviewInput,
                rating: rating,
                cover_icon: coverIcon,
                status: status // ‚≠ê Envia o status para o backend
            };
            
            try {
                // Atualmente, apenas suporta POST (Cria√ß√£o)
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro desconhecido ao salvar.');
                }
                
                showMessage(result.message || "Livro adicionado com sucesso!");

                bookModal.classList.add('hidden');
                bookForm.reset();
                
                loadBooks();
                
            } catch (error) {
                console.error("Erro ao salvar livro:", error);
                showMessage(error.message || "Erro interno ao salvar o livro.", 'error');
            }
        }
        
        async function openBookDetailModal(id) {
            const book = loadedBooks.find(b => b.id === id);
            if (!book) return;

            // Preenchimento dos detalhes
            document.getElementById('detail-title').textContent = book.title;
            document.getElementById('detail-author').textContent = book.author;
            document.getElementById('detail-year').textContent = book.publication_year || 'N/A';
            
            const ratingValue = book.rating ? book.rating.toFixed(1) : 'N/A';
            const stars = book.rating ? '‚òÖ'.repeat(Math.floor(book.rating)) : '';
            document.getElementById('detail-rating').innerHTML = `${ratingValue} <span class="star">${stars}</span>`;
            
            document.getElementById('detail-date-added').textContent = book.date_added || 'N/A';
            document.getElementById('detail-review').textContent = book.review || 'Nenhuma resenha adicionada.';
            
            // ‚≠ê NOVO: Exibe o status no modal de detalhe
            const statusInfo = STATUS_MAP[book.status] || STATUS_MAP['Lendo'];
            document.getElementById('detail-status').textContent = statusInfo.text;


            // Campo de Data Finalizada (Edit√°vel)
            document.getElementById('detail-date-finished').value = book.date_finished || '';
            
            // Armazena o ID do livro no bot√£o Salvar Data
            saveDateBtn.setAttribute('data-book-id', id);
            
            detailModal.classList.remove('hidden');
        }
        
        async function saveFinishedDate() {
            const bookId = saveDateBtn.getAttribute('data-book-id');
            const dateFinished = document.getElementById('detail-date-finished').value.trim();
            const messageEl = document.getElementById('date-save-message');
            
            if (!bookId) return;

            // Formato da data YYYY-MM-DD
            if (dateFinished && !/^\d{4}-\d{2}-\d{2}$/.test(dateFinished)) {
                messageEl.textContent = 'Formato de data inv√°lido. Use AAAA-MM-DD.';
                messageEl.className = 'text-xs text-red-500 mt-2';
                return;
            }

            try {
                const response = await fetch(`/api/books/${bookId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    // Envia a data finalizada e, se estiver preenchida, for√ßa o status para 'Lido'
                    body: JSON.stringify({ 
                        date_finished: dateFinished || null, 
                        status: dateFinished ? 'Lido' : 'Lendo' 
                    })
                });

                if (!response.ok) {
                    throw new Error('Falha ao salvar a data.');
                }
                
                messageEl.textContent = 'Data de finaliza√ß√£o salva com sucesso! O Progresso Mensal ser√° atualizado.';
                messageEl.className = 'text-xs text-cottage-accent mt-2';
                
                // Recarrega a lista para atualizar o Progresso Mensal e o card
                loadBooks();
                
            } catch (error) {
                console.error("Erro ao salvar data:", error);
                messageEl.textContent = 'Erro ao salvar a data. Tente novamente.';
                messageEl.className = 'text-xs text-red-500 mt-2';
            }
        }

        /**
         * CRONOGRAMA (SCHEDULE)
         */
        async function loadSchedule() {
            const loadingEl = document.getElementById('schedule-loading');
            if (loadingEl) { 
                loadingEl.classList.remove('hidden');
            }

            try {
                const response = await fetch('/api/schedule');
                if (!response.ok) throw new Error('Falha ao carregar cronograma.');
                const items = await response.json();
                renderSchedule(items);
            } catch (error) {
                console.error("Erro ao carregar cronograma:", error);
                scheduleList.innerHTML = `<li class="text-red-500">Erro ao carregar.</li>`;
            } finally {
                if (loadingEl) { 
                    loadingEl.classList.add('hidden');
                }
            }
        }

        function renderSchedule(items) {
            scheduleList.innerHTML = '';
            

            if (items.length === 0) {
                scheduleList.innerHTML = `<li class="text-cottage-detail italic">Nenhuma atividade agendada.</li>`;
                return;
            }

            items.forEach(item => {
                const li = document.createElement('li');
                // ‚≠ê NOVO: Classe para o visual pautado
                li.className = 'schedule-item flex justify-between items-center group hover:bg-cottage-bg/50 p-0 -m-0 rounded-none';
                li.setAttribute('data-id', item.id);
                
                const importantIcon = item.is_important === 1 ? `<span class="important text-base font-bold mr-1" title="Importante">!</span>` : '';
                const favoriteIcon = item.is_favorite === 1 ? `<span class="star text-base mr-1" title="Favorito">‚òÖ</span>` : '';

                // ‚≠ê NOVO: Ordem dos √≠cones antes do texto
                li.innerHTML = `
                    <div class="flex items-center space-x-1">
                        ${importantIcon}
                        ${favoriteIcon}
                        <span class="text-cottage-detail">${item.activity}</span>
                    </div>
                    <div class="schedule-item-actions flex items-center space-x-2">
                        <span class="text-cottage-accent font-bold text-xs">${item.period}</span>
                        <button data-id="${item.id}" data-action="edit-schedule" class="text-cottage-detail hover:text-cottage-primary transition duration-200" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                        </button>
                    </div>
                `;
                // ‚≠ê Anexando ao elemento pai correto
                scheduleList.appendChild(li);
            });
        }
        
        async function openScheduleModal(id = null) {
            scheduleForm.reset();
            document.getElementById('schedule-item-id').value = '';
            // For√ßa os checkboxes a serem desmarcados
            document.getElementById('is_important').checked = false;
            document.getElementById('is_favorite_schedule').checked = false;
            deleteScheduleBtn.classList.add('hidden');
            
            if (id) {
                try {
                    const response = await fetch(`/api/schedule/${id}`);
                    if (!response.ok) throw new Error('Item n√£o encontrado.');
                    const item = await response.json();

                    document.getElementById('schedule-item-id').value = id;
                    document.getElementById('activity').value = item.activity;
                    document.getElementById('period').value = item.period;
                    document.getElementById('is_important').checked = item.is_important === 1;
                    document.getElementById('is_favorite_schedule').checked = item.is_favorite === 1;

                    document.getElementById('schedule-modal-title').textContent = 'Editar Atividade';
                    document.getElementById('save-schedule-btn').textContent = 'Salvar Altera√ß√µes';
                    deleteScheduleBtn.classList.remove('hidden');
                } catch (error) {
                    showMessage(error.message, 'error');
                    return;
                }
            } else {
                 document.getElementById('schedule-modal-title').textContent = 'Adicionar Atividade';
                 document.getElementById('save-schedule-btn').textContent = 'Salvar Atividade';
            }
            scheduleModal.classList.remove('hidden');
        }

        async function saveScheduleItem(e) {
            e.preventDefault();

            const itemId = document.getElementById('schedule-item-id').value;
            const activity = document.getElementById('activity').value.trim();
            const period = document.getElementById('period').value;
            const isImportant = document.getElementById('is_important').checked ? 1 : 0;
            const isFavorite = document.getElementById('is_favorite_schedule').checked ? 1 : 0;

            const scheduleData = {
                activity: activity,
                period: period,
                is_important: isImportant,
                is_favorite: isFavorite,
            };

            try {
                const method = itemId ? 'PUT' : 'POST';
                const url = itemId ? `/api/schedule/${itemId}` : '/api/schedule';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro ao salvar cronograma.');
                }

                showMessage(result.message || "Cronograma atualizado!");
                scheduleModal.classList.add('hidden');
                loadSchedule();
            } catch (error) {
                console.error("Erro ao salvar cronograma:", error);
                showMessage(error.message || "Erro interno ao salvar o cronograma.", 'error');
            }
        }
        
        async function deleteScheduleItem() {
            const itemId = document.getElementById('schedule-item-id').value;
            // Use um modal customizado ou box de confirma√ß√£o, n√£o alert/confirm
            const isConfirmed = window.confirm('Tem certeza que deseja excluir esta atividade?');
            if (!itemId || !isConfirmed) return;
            
            try {
                const response = await fetch(`/api/schedule/${itemId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Falha ao excluir item.');
                
                showMessage("Atividade removida do cronograma.", 'success');
                scheduleModal.classList.add('hidden');
                loadSchedule();
            } catch (error) {
                console.error("Erro ao excluir cronograma:", error);
                showMessage(error.message || "Erro ao excluir atividade.", 'error');
            }
        }

        /**
         * M√âTRICAS (PROGRESSO E PERFORMANCE)
         */
        async function loadMetrics() {
            try {
                const response = await fetch('/api/metrics');
                if (!response.ok) throw new Error('Falha ao carregar m√©tricas.');
                const metrics = await response.json();

                // Progresso Mensal (Livros finalizados no m√™s)
                progressIndicator.textContent = metrics.progress_mensal_count;
                
                // Performance Anual (M√©dia de avalia√ß√£o)
                const rating = metrics.performance_anual;
                const ratingDisplay = rating.toFixed(1);
                
                // ‚≠ê NOVO: Adiciona o gr√°fico de estrelas ao indicador de performance
                const starsHtml = renderStarRating(rating);
                performanceIndicator.innerHTML = `
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-3xl">${ratingDisplay}</span>
                        <div class="text-xl flex space-x-0.5">${starsHtml}</div>
                    </div>
                `;
                
            } catch (error) {
                console.error("Erro ao carregar m√©tricas:", error);
                // Define valores padr√£o se houver erro
                progressIndicator.textContent = 'N/A';
                performanceIndicator.innerHTML = '0.0 <div class="text-xl flex space-x-0.5"><span class="text-gray-300">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span></div>';
            }
        }

        function initApp() {
            loadBooks(); // Carrega livros e m√©tricas em seguida
            loadSchedule();
        }

        // --- EVENT LISTENERS ---

        // Livro
        addBookBtn.addEventListener('click', () => {
             bookForm.reset();
             document.getElementById('book-id').value = '';
             document.getElementById('modal-title').textContent = "Adicionar Novo Livro";
             document.getElementById('submit-button').textContent = "Salvar Livro";
             // ‚≠ê Preenche os seletores
             populateCoverIconSelector('initial');
             populateStatusSelector('Lendo'); // Padr√£o 'Lendo'
             bookModal.classList.remove('hidden');
        });
        
        closeBookModalBtn.addEventListener('click', () => {
             bookModal.classList.add('hidden');
        });

        bookForm.addEventListener('submit', saveBook);
        
        // Detalhes do Livro
        saveDateBtn.addEventListener('click', saveFinishedDate);
        closeDetailModalBtn.addEventListener('click', () => {
            detailModal.classList.add('hidden');
            document.getElementById('date-save-message').textContent = '';
        });
        
        // Cronograma
        addScheduleBtn.addEventListener('click', () => openScheduleModal());
        closeScheduleModalBtn.addEventListener('click', () => scheduleModal.classList.add('hidden'));
        scheduleForm.addEventListener('submit', saveScheduleItem);
        deleteScheduleBtn.addEventListener('click', deleteScheduleItem);
        
        // Listener de edi√ß√£o de item do cronograma (delega√ß√£o de eventos)
        scheduleList.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-action="edit-schedule"]');
            if (target) {
                const id = parseInt(target.getAttribute('data-id'));
                openScheduleModal(id);
            }
        });

        logoutBtn.addEventListener('click', handleLogout);

        window.onload = initApp;

    </script>
</body>
</html>